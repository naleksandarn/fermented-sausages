<!DOCTYPE html>
<html lang="sr">

<head>
    <meta charset="UTF-8">
    <title>Monitoring Fermentacije</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- SIDEBAR STILOVI --- */
        .sidebar-search {
            padding: 15px;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-search input {
            padding: 12px;
            /* Poveƒáan padding */
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            /* Poveƒáan font */
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .sidebar-search input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-reset {
            background-color: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-reset:hover {
            background-color: #e2e8f0;
            color: #334155;
            border-color: #94a3b8;
        }

        .batch-list-item {
            cursor: pointer;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .batch-list-item:hover {
            background-color: #f8fafc;
        }

        .batch-list-item.active {
            background-color: #eff6ff;
            border-left: 4px solid #2563eb;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Monitoring Fermentacije</h1>

            <button onclick="window.location.href='home.html'" class="btn-secondary">üè† Poƒçetna</button>
            <button onclick="window.location.href='monitoring_menu.html'" class="btn-secondary">‚Üê Nazad</button>
        </header>

        <div class="monitoring-container">
            <div class="sidebar">
                <div class="sidebar-header">Izaberite Seriju</div>

                <div class="sidebar-search">
                    <input type="text" id="searchBatch" placeholder="üîç Pretra≈æi Seriju...">
                    <input type="text" id="searchLot" placeholder="üîç Pretra≈æi LOT...">
                    <button id="resetBtn" class="btn-reset" style="display: none;">‚úñ Poni≈°ti pretragu</button>
                </div>

                <ul class="batch-list" id="batchList">
                </ul>
            </div>

            <div class="chart-area">
                <h2 id="chartTitle" style="margin-bottom: 20px; color: #333;">Izaberite seriju za prikaz</h2>
                <div class="chart-wrapper">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let myChart = null;
        let allBatchesData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) window.location.href = 'login.html';

            await loadBatches();

            // Event listeneri
            document.getElementById('searchBatch').addEventListener('input', filterBatches);
            document.getElementById('searchLot').addEventListener('input', filterBatches);

            // Dugme Poni≈°ti
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchBatch').value = '';
                document.getElementById('searchLot').value = '';
                filterBatches(); // Ovo ƒáe sakriti dugme i vratiti listu
            });
        });

        // 1. Uƒçitaj listu serija
        async function loadBatches() {
            try {
                const res = await fetch(`${API_URL}/dashboard`);
                allBatchesData = await res.json();
                renderBatchList(allBatchesData);
            } catch (err) {
                console.error(err);
            }
        }

        // 2. Renderovanje liste
        function renderBatchList(data) {
            const list = document.getElementById('batchList');
            list.innerHTML = '';

            if (data.length === 0) {
                list.innerHTML = '<li style="padding:20px; color:gray; text-align:center;">Nema rezultata.</li>';
                return;
            }

            data.forEach(b => {
                const li = document.createElement('li');
                li.className = 'batch-list-item';
                li.innerHTML = `
                    <div style="font-weight:bold; color:#1e293b; font-size:1.1rem;">${b.batch_code}</div>
                    <div style="font-size:0.9rem; color:#64748b;">${b.product_name}</div>
                    <div style="font-size:0.8rem; color:#94a3b8; margin-top:2px;">LOT: ${b.lot_number || '-'}</div>
                `;
                li.onclick = () => selectBatch(b, li);
                list.appendChild(li);
            });
        }

        // 3. Logika filtriranja
        function filterBatches() {
            const sBatch = document.getElementById('searchBatch').value.toLowerCase();
            const sLot = document.getElementById('searchLot').value.toLowerCase();
            const resetBtn = document.getElementById('resetBtn');

            // Prika≈æi dugme "Poni≈°ti" samo ako ima nekog teksta
            if (sBatch || sLot) {
                resetBtn.style.display = 'block';
            } else {
                resetBtn.style.display = 'none';
            }

            const filtered = allBatchesData.filter(b => {
                const matchBatch = b.batch_code.toLowerCase().includes(sBatch);
                const matchLot = (b.lot_number || '').toLowerCase().includes(sLot);
                return matchBatch && matchLot;
            });

            renderBatchList(filtered);
        }

        // 4. Klik na seriju
        async function selectBatch(batch, element) {
            document.querySelectorAll('.batch-list-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('chartTitle').textContent = `Analiza: ${batch.batch_code} (${batch.product_name})`;

            try {
                const res = await fetch(`${API_URL}/batches/${batch.id}/history`);
                const history = await res.json();
                processAndRenderChart(history);
            } catch (err) { console.error(err); }
        }

        // 5. Obrada podataka i crtanje
        function processAndRenderChart(data) {
            const dailyStats = {};

            data.forEach(item => {
                const date = new Date(item.measured_at).toLocaleDateString('sr-RS');

                if (!dailyStats[date]) {
                    dailyStats[date] = {
                        phSum: 0, phCount: 0,
                        kaloSum: 0, kaloCount: 0,
                        netWeightSum: 0, netWeightCount: 0
                    };
                }

                const tare = parseFloat(item.tare_weight);
                const stickWeight = parseInt(item.stick_count) * 0.4;
                const startGross = parseFloat(item.start_gross);
                const currentGross = parseFloat(item.gross_weight);

                const startNet = (startGross - tare - stickWeight);
                const currentNet = (currentGross - tare - stickWeight);

                if (currentNet > 0 && startNet > 0) {
                    const kalo = ((startNet - currentNet) / startNet) * 100;
                    dailyStats[date].kaloSum += kalo;
                    dailyStats[date].kaloCount++;
                    dailyStats[date].netWeightSum += currentNet;
                    dailyStats[date].netWeightCount++;
                }

                if (item.ph_value) {
                    dailyStats[date].phSum += parseFloat(item.ph_value);
                    dailyStats[date].phCount++;
                }
            });

            const labels = Object.keys(dailyStats).reverse();

            const phData = [];
            const kaloData = [];

            labels.forEach(date => {
                const stat = dailyStats[date];
                const avgPh = stat.phCount > 0 ? (stat.phSum / stat.phCount).toFixed(2) : null;
                const avgKalo = stat.kaloCount > 0 ? (stat.kaloSum / stat.kaloCount).toFixed(2) : null;

                phData.push(avgPh);
                kaloData.push(avgKalo);
            });

            renderChart(labels, phData, kaloData);
        }

        function renderChart(labels, phData, kaloData) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Proseƒçan pH',
                            data: phData,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef4444',
                            yAxisID: 'y',
                            tension: 0.3
                        },
                        {
                            label: 'Proseƒçan Kalo (%)',
                            data: kaloData,
                            borderColor: '#2563eb',
                            backgroundColor: '#2563eb',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'pH Vrednost' },
                            min: 4.5,
                            max: 6.5
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Gubitak te≈æine (%)' },
                            grid: { drawOnChartArea: false },
                            min: 0,
                            max: 45
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>