<!DOCTYPE html>
<html lang="sr">

<head>
    <meta charset="UTF-8">
    <title>Dashboard - Procure Monitor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- LAYOUT SA SIDEBAROM --- */
        .dash-container {
            display: flex;
            min-height: calc(100vh - 80px);
            background: #f8fafc;
        }

        /* Sidebar */
        .dash-sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #f1f5f9;
            color: #333;
        }

        .nav-btn.active {
            background: #eff6ff;
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        /* Content Area */
        .dash-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px;
        }

        .kpi-title {
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .kpi-val {
            font-size: 2rem;
            font-weight: 800;
            color: #1e293b;
            margin-top: 10px;
        }

        .kpi-unit {
            font-size: 1rem;
            color: #94a3b8;
            font-weight: normal;
            margin-left: 5px;
        }

        .kpi-sub {
            font-size: 0.85rem;
            color: #16a34a;
            margin-top: auto;
            font-weight: 500;
        }

        /* Chart Containers */
        .chart-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-canvas-wrapper {
            flex: 1;
            position: relative;
            width: 100%;
            min-height: 0;
        }

        /* Tabela */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 12px 20px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-green {
            background: #dcfce7;
            color: #166534;
        }

        .status-yellow {
            background: #fef9c3;
            color: #854d0e;
        }

        .status-red {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- KALENDAR --- */
        .calendar-wrapper {
            margin-bottom: 40px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .cal-day {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            min-height: 140px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
            cursor: pointer;
        }

        .cal-day:hover {
            border-color: #2563eb;
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .cal-header {
            font-size: 0.85rem;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .cal-header.today {
            color: #2563eb;
        }

        .cal-event {
            background: #eff6ff;
            border-left: 3px solid #2563eb;
            padding: 6px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .cal-prod {
            font-weight: bold;
            color: #1e3a8a;
            display: block;
            margin-bottom: 2px;
        }

        .cal-stat {
            color: #64748b;
        }

        /* --- NOTIFIKACIJE STILOVI --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-wrapper {
            position: relative;
            cursor: pointer;
            margin-right: 20px;
            display: flex;
            align-items: center;
        }

        .bell-icon {
            font-size: 1.5rem;
            /* Ako je header taman, dodaj filter: invert(1); */
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid white;
            display: none;
        }

        .notif-dropdown {
            position: absolute;
            top: 40px;
            right: 0;
            width: 300px;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        .notif-header {
            padding: 10px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: bold;
            color: #334155;
            border-radius: 8px 8px 0 0;
        }

        .notif-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .notif-item {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #475569;
        }

        .notif-item:hover {
            background-color: #f1f5f9;
        }

        .notif-empty {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        @media (max-width: 1200px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 900px) {
            .chart-row {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="app-container" style="padding-bottom: 0;">
        <header class="app-header">
            <h1>Dashboard</h1>

            <div style="display: flex; align-items: center;">
                <div class="notification-wrapper" id="notifWrapper">
                    <span class="bell-icon">üîî</span>
                    <span class="badge" id="notifBadge">0</span>

                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="notif-header">Obave≈°tenja</div>
                        <ul class="notif-list" id="notifList">
                        </ul>
                    </div>
                </div>

                <button onclick="window.location.href='home.html'" class="btn-secondary">üè† Poƒçetna</button>
            </div>
        </header>

        <div class="dash-container">
            <div class="dash-sidebar">
                <button class="nav-btn active" onclick="showSection('general', this)">
                    <span class="nav-icon">üìä</span> Generalni pregled
                </button>
                <button class="nav-btn" onclick="showSection('products', this)">
                    <span class="nav-icon">ü•©</span> Po proizvodima
                </button>
                <button class="nav-btn" onclick="showSection('schedule', this)">
                    <span class="nav-icon">üìÖ</span> Raspored pakovanja
                </button>
                <button class="nav-btn" onclick="showSection('kalo', this)">
                    <span class="nav-icon">üìâ</span> Pregled kala
                </button>
                <button class="nav-btn" style="opacity: 0.5; cursor: not-allowed;">
                    <span class="nav-icon">üí∞</span> Finansije (Uskoro)
                </button>
            </div>

            <div class="dash-content">

                <div id="general" class="section active">
                    <h2 style="margin-bottom: 20px;">Pregled Pogona</h2>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-title">Ukupno Proizvoda</div>
                            <div class="kpi-val" id="g-weight">0<span class="kpi-unit">kg</span></div>
                            <div class="kpi-sub">Trenutno u zrenju</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Ukupno Kolica</div>
                            <div class="kpi-val" id="g-trolleys">0</div>
                            <div class="kpi-sub" style="color:#2563eb;">Ramova u pogonu</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Ukupno Tura</div>
                            <div class="kpi-val" id="g-batches">0</div>
                            <div class="kpi-sub">Aktivnih serija</div>
                        </div>
                    </div>

                    <div class="chart-row">
                        <div class="chart-box">
                            <div class="chart-header">Ukupno kolica po proizvodima</div>
                            <div class="chart-canvas-wrapper"><canvas id="trolleyChart"></canvas></div>
                        </div>
                        <div class="chart-box">
                            <div class="chart-header">Struktura proizvodnje</div>
                            <div class="chart-canvas-wrapper"><canvas id="structureChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="products" class="section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="color:#333;">Analiza Proizvoda</h2>
                        <select id="productFilter"
                            style="padding:10px; font-size:1.1rem; border-radius:8px; border:2px solid #2563eb; background:white; cursor:pointer; min-width: 200px;">
                        </select>
                    </div>

                    <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="kpi-card" style="border-bottom: 4px solid #f59e0b;">
                            <div class="kpi-title">Ukupno Sirovo (Neto 1)</div>
                            <div class="kpi-val" id="p-net1">0<span class="kpi-unit">kg</span></div>
                            <div class="kpi-sub">Ulazna masa mesa</div>
                        </div>
                        <div class="kpi-card" style="border-bottom: 4px solid #16a34a;">
                            <div class="kpi-title">Oƒçekivano Gotovo</div>
                            <div class="kpi-val" id="p-net2-est">0<span class="kpi-unit">kg</span></div>
                            <div class="kpi-sub" id="p-kalo-target">Ciljani kalo: -%</div>
                        </div>
                        <div class="kpi-card" style="border-bottom: 4px solid #3b82f6;">
                            <div class="kpi-title">Ukupno Kolica</div>
                            <div class="kpi-val" id="p-trolleys">0</div>
                            <div class="kpi-sub">Anga≈æovani resursi</div>
                        </div>
                    </div>

                    <div class="chart-box" style="height: 400px; margin-top: 20px;">
                        <div class="chart-header">Starost aktivnih serija (vs Cilj)</div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="productDetailChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="schedule" class="section">
                    <h2 style="margin-bottom: 10px;">Raspored Pakovanja</h2>

                    <div class="calendar-wrapper">
                        <h4 style="color:#64748b;">Pregled za narednih 14 dana (Kliknite na dan za filter)</h4>
                        <div id="calendarGrid" class="calendar-grid"></div>
                    </div>

                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; margin-top:40px; border-top:1px solid #e2e8f0; padding-top:20px;">
                        <h3>Detaljna lista</h3>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label style="color:#64748b; font-size:0.9rem;">Oƒçekivani datum:</label>
                            <input type="date" id="scheduleDateFilter"
                                style="padding:8px; border:1px solid #cbd5e1; border-radius:6px;">
                            <button class="btn-secondary" onclick="clearScheduleFilter()"
                                style="padding:8px 12px; font-size:0.8rem;">Prika≈æi sve</button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Datum pakovanja</th>
                                <th>Serija</th>
                                <th>Proizvod</th>
                                <th>Kolica</th>
                                <th>Oƒçekivano (kg)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>

                <div id="kalo" class="section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="color:#333;">Analiza Gubitka Te≈æine (Zavr≈°ene Serije)</h2>
                        <select id="kaloProductFilter"
                            style="padding:10px; font-size:1.1rem; border-radius:8px; border:2px solid #2563eb; background:white; cursor:pointer; min-width: 200px;">
                            <option value="all">Svi proizvodi</option>
                        </select>
                    </div>

                    <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="kpi-card" style="border-bottom: 4px solid #3b82f6;">
                            <div class="kpi-title">Ukupno Napunjeno</div>
                            <div class="kpi-val" id="k-net1">0<span class="kpi-unit">kg</span></div>
                            <div class="kpi-sub">Ulaz (Neto 1)</div>
                        </div>
                        <div class="kpi-card" style="border-bottom: 4px solid #16a34a;">
                            <div class="kpi-title">Ukupno Osu≈°eno</div>
                            <div class="kpi-val" id="k-net2">0<span class="kpi-unit">kg</span></div>
                            <div class="kpi-sub">Izlaz (Neto 2)</div>
                        </div>
                        <div class="kpi-card" style="border-bottom: 4px solid #ef4444;">
                            <div class="kpi-title">Proseƒçan Kalo</div>
                            <div class="kpi-val" id="k-percent">0.00<span class="kpi-unit">%</span></div>
                            <div class="kpi-sub">Ukupan gubitak mase</div>
                        </div>
                    </div>

                    <div class="chart-box" style="height: 400px; margin-top: 20px;">
                        <div class="chart-header">Kalo po serijama (%)</div>
                        <div class="chart-canvas-wrapper"><canvas id="kaloChart"></canvas></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let rawData = null;

        let chart1 = null;
        let chart2 = null;
        let productChartRef = null;
        let kaloChartRef = null;

        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user || (user.role !== 'admin' && user.role !== 'ceo')) {
            window.location.href = 'home.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            // INICIJALIZACIJA NOTIFIKACIJA
            setupNotifications(user.role);
        });

        // --- NOTIFIKACIJE LOGIKA ---
        function setupNotifications(role) {
            const badge = document.getElementById('notifBadge');
            const list = document.getElementById('notifList');
            const dropdown = document.getElementById('notifDropdown');
            const wrapper = document.getElementById('notifWrapper');

            if (!wrapper) return;

            // 1. Provera servera
            async function checkNotifications() {
                try {
                    const res = await fetch(`${API_URL}/notifications?role=${role}`);
                    const data = await res.json();

                    if (data.length > 0) {
                        badge.style.display = 'flex';
                        badge.textContent = data.length > 9 ? '9+' : data.length;

                        list.innerHTML = '';
                        data.forEach(n => {
                            const li = document.createElement('li');
                            li.className = 'notif-item';
                            const time = new Date(n.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
                            li.innerHTML = `<div>${n.message}</div><div style="font-size:0.7rem; color:#94a3b8; margin-top:4px;">${time}</div>`;
                            list.appendChild(li);
                        });
                    } else {
                        badge.style.display = 'none';
                        list.innerHTML = '<li class="notif-empty">Nema novih obave≈°tenja</li>';
                    }
                } catch (err) { console.error("Notif error", err); }
            }

            // 2. Klik na zvonce
            wrapper.addEventListener('click', async () => {
                const isVisible = dropdown.style.display === 'block';

                if (!isVisible) {
                    dropdown.style.display = 'block';
                    // Mark as read
                    if (badge.style.display !== 'none') {
                        await fetch(`${API_URL}/notifications/read`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ role })
                        });
                        badge.style.display = 'none';
                    }
                } else {
                    dropdown.style.display = 'none';
                }
            });

            // 3. Zatvori na klik van
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            checkNotifications();
            setInterval(checkNotifications, 30000);
        }
        // ---------------------------

        async function loadData() {
            try {
                const res = await fetch(`${API_URL}/analytics`);
                rawData = await res.json();

                renderGeneral();
                renderSchedule();
                renderCalendar();
                populateProductFilter();
                initKaloView();
            } catch (err) { console.error(err); alert("Gre≈°ka pri uƒçitavanju."); }
        }

        window.showSection = function (id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- 1. GENERAL ---
        function renderGeneral() {
            const kpi = rawData.kpi;
            document.getElementById('g-weight').firstChild.nodeValue = parseFloat(kpi.totalWeight).toLocaleString('sr-RS');
            document.getElementById('g-trolleys').textContent = kpi.totalTrolleys;
            document.getElementById('g-batches').textContent = kpi.totalBatches;

            const ctx1 = document.getElementById('trolleyChart').getContext('2d');
            if (chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: rawData.charts.trolleysByProduct.map(d => d.name),
                    datasets: [{ label: 'Broj Kolica', data: rawData.charts.trolleysByProduct.map(d => d.count), backgroundColor: '#3b82f6', borderRadius: 6, barThickness: 40 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            const ctx2 = document.getElementById('structureChart').getContext('2d');
            if (chart2) chart2.destroy();
            chart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: rawData.charts.structure.map(d => d.name),
                    datasets: [{ data: rawData.charts.structure.map(d => d.count), backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#3b82f6'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        // --- 2. PRODUCTS ---
        function populateProductFilter() {
            const select = document.getElementById('productFilter');
            select.innerHTML = '';
            if (!rawData.productStats || rawData.productStats.length === 0) { select.innerHTML = '<option>Nema podataka</option>'; return; }
            rawData.productStats.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name; opt.textContent = p.name; select.appendChild(opt);
            });
            updateProductView();
            select.addEventListener('change', updateProductView);
        }

        function updateProductView() {
            const selectedName = document.getElementById('productFilter').value;
            const stats = rawData.productStats.find(p => p.name === selectedName);
            if (stats) {
                const net1 = parseFloat(stats.total_net_1) || 0;
                document.getElementById('p-net1').firstChild.nodeValue = net1.toLocaleString('sr-RS', { maximumFractionDigits: 0 });
                const targetLoss = parseFloat(stats.standard_loss_percentage) || 0;
                const estNet2 = net1 * (1 - (targetLoss / 100));
                document.getElementById('p-net2-est').firstChild.nodeValue = estNet2.toLocaleString('sr-RS', { maximumFractionDigits: 0 });
                document.getElementById('p-kalo-target').textContent = `Ciljani kalo: ${targetLoss}%`;
                document.getElementById('p-trolleys').textContent = stats.total_trolleys;
            }
            const batches = rawData.activeList.filter(b => b.product_name === selectedName);
            renderProductChart(batches);
        }

        function renderProductChart(batches) {
            batches.sort((a, b) => b.days_old - a.days_old);
            const labels = batches.map(b => b.batch_code);
            const dataAge = batches.map(b => b.days_old);
            const targetDays = batches.length > 0 ? batches[0].target_duration_days : 0;
            const colors = dataAge.map(age => age >= targetDays ? '#16a34a' : '#3b82f6');

            if (productChartRef) productChartRef.destroy();
            const ctx = document.getElementById('productDetailChart').getContext('2d');
            productChartRef = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Dana u zrenju', data: dataAge, backgroundColor: colors, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }

        // --- 3. SCHEDULE ---
        function renderCalendar() {
            const container = document.getElementById('calendarGrid');
            container.innerHTML = '';
            const today = new Date();
            const eventsByDate = {};

            rawData.activeList.forEach(b => {
                const prodDate = new Date(b.production_date);
                const targetDays = parseInt(b.target_duration_days);
                const packDateObj = new Date(prodDate);
                packDateObj.setDate(prodDate.getDate() + targetDays);
                const dateKey = packDateObj.toISOString().split('T')[0];
                if (!eventsByDate[dateKey]) eventsByDate[dateKey] = [];
                eventsByDate[dateKey].push(b);
            });

            for (let i = 0; i < 14; i++) {
                const d = new Date();
                d.setDate(today.getDate() + i);
                const dateKey = d.toISOString().split('T')[0];
                const displayDate = d.toLocaleDateString('sr-RS', { weekday: 'short', day: 'numeric', month: 'numeric' });
                const isToday = (i === 0) ? 'today' : '';
                const items = eventsByDate[dateKey] || [];

                const dailySummary = {};
                items.forEach(b => {
                    if (!dailySummary[b.product_name]) dailySummary[b.product_name] = { trolleys: 0, weight: 0 };
                    const net1 = parseFloat(b.total_net_1) || 0;
                    const loss = parseFloat(b.standard_loss_percentage) || 0;
                    const estNet2 = net1 * (1 - (loss / 100));
                    dailySummary[b.product_name].trolleys += parseInt(b.trolley_count);
                    dailySummary[b.product_name].weight += estNet2;
                });

                let eventsHtml = '';
                if (Object.keys(dailySummary).length === 0) {
                    eventsHtml = '<div style="color:#cbd5e1; font-size:0.8rem; text-align:center; margin-top:20px;">-</div>';
                } else {
                    for (const [prod, stats] of Object.entries(dailySummary)) {
                        eventsHtml += `<div class="cal-event"><span class="cal-prod">${prod}</span><span class="cal-stat">${stats.trolleys} kol. | ~${stats.weight.toFixed(0)}kg</span></div>`;
                    }
                }

                const dayCard = document.createElement('div');
                dayCard.className = 'cal-day';
                dayCard.innerHTML = `<div class="cal-header ${isToday}">${displayDate}</div><div style="flex:1;">${eventsHtml}</div>`;
                dayCard.onclick = () => {
                    document.getElementById('scheduleDateFilter').value = dateKey;
                    renderSchedule();
                    document.querySelector('.data-table').scrollIntoView({ behavior: 'smooth', block: 'center' });
                };
                container.appendChild(dayCard);
            }
        }

        function renderSchedule() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const filterDate = document.getElementById('scheduleDateFilter').value;

            rawData.activeList.forEach(b => {
                const prodDate = new Date(b.production_date);
                const targetDays = parseInt(b.target_duration_days);
                const packDateObj = new Date(prodDate);
                packDateObj.setDate(prodDate.getDate() + targetDays);
                const packDateStr = packDateObj.toLocaleDateString('sr-RS');
                const packDateISO = packDateObj.toISOString().split('T')[0];

                if (filterDate && filterDate !== packDateISO) return;

                const left = b.days_remaining;
                let status = `<span class="status-badge status-green">U roku</span>`;
                if (left < 0) status = `<span class="status-badge status-red">Kasni ${Math.abs(left)} d</span>`;
                else if (left < 5) status = `<span class="status-badge status-yellow">Jo≈° ${left} d</span>`;

                const net1 = parseFloat(b.total_net_1) || 0;
                const loss = parseFloat(b.standard_loss_percentage) || 0;
                const estNet2 = net1 * (1 - (loss / 100));

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold;">${packDateStr}</td>
                    <td>${b.batch_code}<br><span style="font-size:0.8rem; color:#666;">LOT: ${b.lot_number || '-'}</span></td>
                    <td>${b.product_name}</td>
                    <td style="text-align:center;">${b.trolley_count}</td>
                    <td style="font-weight:bold; color:#2563eb;">~${estNet2.toFixed(0)} kg</td>
                    <td>${status}</td>
                `;
                tbody.appendChild(tr);
            });
            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#666;">Nema podataka.</td></tr>';
        }

        document.getElementById('scheduleDateFilter').addEventListener('change', renderSchedule);
        window.clearScheduleFilter = function () { document.getElementById('scheduleDateFilter').value = ''; renderSchedule(); }

        // --- 4. KALO ---
        function initKaloView() {
            const select = document.getElementById('kaloProductFilter');
            select.innerHTML = '<option value="all">Svi proizvodi</option>';
            if (rawData.historyStats) {
                const unique = [...new Set(rawData.historyStats.map(b => b.product_name))];
                unique.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name; opt.textContent = name; select.appendChild(opt);
                });
            }
            updateKaloView();
            select.addEventListener('change', updateKaloView);
        }

        function updateKaloView() {
            const filter = document.getElementById('kaloProductFilter').value;
            let list = rawData.historyStats || [];
            if (filter !== 'all') list = list.filter(b => b.product_name === filter);

            let totalNet1 = 0, totalNet2 = 0;
            list.forEach(b => {
                totalNet1 += parseFloat(b.total_net_1) || 0;
                totalNet2 += parseFloat(b.total_net_2) || 0;
            });
            let totalKalo = totalNet1 > 0 ? ((totalNet1 - totalNet2) / totalNet1) * 100 : 0;

            document.getElementById('k-net1').firstChild.nodeValue = totalNet1.toLocaleString('sr-RS', { maximumFractionDigits: 0 });
            document.getElementById('k-net2').firstChild.nodeValue = totalNet2.toLocaleString('sr-RS', { maximumFractionDigits: 0 });
            document.getElementById('k-percent').firstChild.nodeValue = totalKalo.toFixed(2);

            renderKaloChart(list);
        }

        function renderKaloChart(list) {
            const sortedList = [...list].reverse();
            const labels = sortedList.map(b => b.batch_code);
            const data = sortedList.map(b => {
                const n1 = parseFloat(b.total_net_1);
                const n2 = parseFloat(b.total_net_2);
                return n1 > 0 ? (((n1 - n2) / n1) * 100).toFixed(2) : 0;
            });

            if (kaloChartRef) kaloChartRef.destroy();
            const ctx = document.getElementById('kaloChart').getContext('2d');
            kaloChartRef = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kalo (%)',
                        data: data,
                        backgroundColor: '#ef4444',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>
</body>

</html>